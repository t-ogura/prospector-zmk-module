/*
 * Copyright (c) 2026 The ZMK Contributors
 * SPDX-License-Identifier: MIT
 *
 * Scanner Pocket - Sharp Memory LCD (LS013B7DH05)
 * SPI connection to Seeed XIAO nRF52840
 *
 * Current test wiring (temporary debug setup):
 *   D8  (P1.13) = CS
 *   D9  (P1.14) = SCLK
 *   D10 (P1.15) = SI (MOSI)
 *
 * XIAO nRF52840 Pin Mapping Reference:
 *   D0 = P0.02    D6 = P1.11
 *   D1 = P0.03    D7 = P1.12
 *   D2 = P0.28    D8 = P1.13
 *   D3 = P0.29    D9 = P1.14
 *   D4 = P0.04    D10= P1.15
 *   D5 = P0.05
 */

#include <dt-bindings/zmk/matrix_transform.h>
#include <physical_layouts.dtsi>

/ {
    chosen {
        zmk,kscan = &kscan0;
        zmk,physical-layout = &default_layout;
        zephyr,display = &memory_lcd;
    };

    default_layout: default_layout {
        compatible = "zmk,physical-layout";
        display-name = "Scanner Pocket Layout";
        transform = <&default_transform>;

        keys
            = <&key_physical_attrs 100 100    0    0      0     0     0>
            ;
    };

    default_transform: keymap_transform_0 {
        compatible = "zmk,matrix-transform";
        columns = <1>;
        rows = <1>;
        map = <RC(0,0)>;
    };

    /* Navigation button: D3 (GND) + D6 (Input)
     * Press button to toggle between Main and Keyboard List screens
     */
    gpio_keys {
        compatible = "gpio-keys";
        nav_button: nav_button {
            gpios = <&xiao_d 6 (GPIO_ACTIVE_LOW | GPIO_PULL_UP)>;
            label = "Navigation Button";
        };
    };

    /* Dummy kscan - Scanner Pocket is display-only device */
    kscan0: kscan {
        compatible = "zmk,kscan-gpio-direct";
        wakeup-source;
        input-gpios = <&xiao_d 0 (GPIO_ACTIVE_LOW | GPIO_PULL_UP)>;
    };
};

/* D3 as GND output for button */
&gpio0 {
    status = "okay";
    button_gnd: button_gnd {
        gpio-hog;
        gpios = <29 GPIO_ACTIVE_HIGH>;  /* D3 = P0.29 */
        output-low;
        line-name = "Button GND";
    };
};

/* Disable default SPI to avoid conflicts */
&spi2 {
    status = "disabled";
};

/* SPI pin configuration for Sharp Memory LCD */
&pinctrl {
    spi1_default: spi1_default {
        group1 {
            psels = <NRF_PSEL(SPIM_SCK, 1, 14)>,   /* D9 = P1.14 = SCLK */
                    <NRF_PSEL(SPIM_MOSI, 1, 15)>;  /* D10 = P1.15 = SI (MOSI) */
        };
    };

    spi1_sleep: spi1_sleep {
        group1 {
            psels = <NRF_PSEL(SPIM_SCK, 1, 14)>,
                    <NRF_PSEL(SPIM_MOSI, 1, 15)>;
            low-power-enable;
        };
    };
};

/* SPI1 configuration for Sharp Memory LCD */
&spi1 {
    status = "okay";
    compatible = "nordic,nrf-spim";
    pinctrl-0 = <&spi1_default>;
    pinctrl-1 = <&spi1_sleep>;
    pinctrl-names = "default", "sleep";
    cs-gpios = <&gpio1 13 GPIO_ACTIVE_HIGH>;  /* D8 = P1.13 = CS (Active HIGH!) */

    memory_lcd: ls0xx@0 {
        compatible = "sharp,ls0xx";
        reg = <0>;
        spi-max-frequency = <1000000>;  /* 1MHz - safe for Memory LCD */
        width = <144>;
        height = <168>;
    };
};
